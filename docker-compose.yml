version: '3.8'

services:
  # SQL Server - Mesmo utilizado no TestContainer
  sqlserver:
    image: mcr.microsoft.com/mssql/server:2019-latest
    container_name: ${COMPOSE_PROJECT_NAME}-sqlserver
    environment:
      - ACCEPT_EULA=Y
      - SA_PASSWORD=${MSSQL_SA_PASSWORD}
      - MSSQL_PID=${MSSQL_PID}
    ports:
      - "${MSSQL_PORT}:1433"
    volumes:
      - ${SQLSERVER_VOLUME}:/var/opt/mssql
    healthcheck:
      test: ["CMD", "/opt/mssql-tools18/bin/sqlcmd", "-S", "localhost", "-U", "sa", "-P", "${MSSQL_SA_PASSWORD}", "-Q", "SELECT 1", "-C"]
      interval: ${HEALTHCHECK_INTERVAL}
      timeout: ${HEALTHCHECK_TIMEOUT}
      retries: ${HEALTHCHECK_RETRIES}
      start_period: ${HEALTHCHECK_START_PERIOD}
    networks:
      - charging-network

  # API - Charging.Api
  api:
    build:
      context: .
      dockerfile: Charging.Api/Dockerfile
    container_name: ${COMPOSE_PROJECT_NAME}-api
    environment:
      - ASPNETCORE_ENVIRONMENT=${ASPNETCORE_ENVIRONMENT}
      - ASPNETCORE_URLS=${ASPNETCORE_URLS}
      - ConnectionStrings__DefaultConnection=Server=${DB_SERVER},${DB_PORT};Database=${DB_NAME};User Id=${DB_USER};Password=${MSSQL_SA_PASSWORD};TrustServerCertificate=${DB_TRUST_CERTIFICATE};
    ports:
      - "${API_PORT}:${API_INTERNAL_PORT}"
    depends_on:
      sqlserver:
        condition: service_healthy
    networks:
      - charging-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:80/api/usuarios"]
      interval: ${HEALTHCHECK_INTERVAL}
      timeout: ${HEALTHCHECK_TIMEOUT}
      retries: ${HEALTHCHECK_RETRIES}
      start_period: 20s

  # k6 - Testes de Performance
  k6:
    image: grafana/k6:latest
    container_name: ${COMPOSE_PROJECT_NAME}-k6
    volumes:
      - ./k6-tests:/scripts
      - ./k6-results:${K6_RESULTS_PATH}
    environment:
      - BASE_URL=${K6_BASE_URL}
    depends_on:
      api:
        condition: service_healthy
    networks:
      - charging-network
    command: run /scripts/smoke-test.js --out json=${K6_RESULTS_PATH}/smoke-results.json
    profiles:
      - test

  # k6 - Load Test
  k6-load:
    image: grafana/k6:latest
    container_name: ${COMPOSE_PROJECT_NAME}-k6-load
    volumes:
      - ./k6-tests:/scripts
      - ./k6-results:${K6_RESULTS_PATH}
    environment:
      - BASE_URL=${K6_BASE_URL}
    depends_on:
      api:
        condition: service_healthy
    networks:
      - charging-network
    command: run /scripts/load-test.js --out json=${K6_RESULTS_PATH}/load-results.json
    profiles:
      - test

  # k6 - Stress Test
  k6-stress:
    image: grafana/k6:latest
    container_name: ${COMPOSE_PROJECT_NAME}-k6-stress
    volumes:
      - ./k6-tests:/scripts
      - ./k6-results:${K6_RESULTS_PATH}
    environment:
      - BASE_URL=${K6_BASE_URL}
    depends_on:
      api:
        condition: service_healthy
    networks:
      - charging-network
    command: run /scripts/stress-test.js --out json=${K6_RESULTS_PATH}/stress-results.json
    profiles:
      - test

networks:
  charging-network:
    driver: bridge

volumes:
  sqlserver-data:
    name: ${COMPOSE_PROJECT_NAME}-${SQLSERVER_VOLUME}
    driver: local

